# TA系统外部接口详细设计说明书 (V1.0)

## 1\. 通用规范 (General Standards)

  * **文件格式**: CSV (Comma-Separated Values)
  * **字符编码**: UTF-8
  * **文件名日期格式**: `yyyyMMdd` (例如 `20231027`)
  * **数值格式**:
      * **金额/份额**: 保留2位或4位小数的浮点数字符串 (Decimal)，例如 `1000.00`。
      * **布尔值**: 即使是逻辑字段，也使用特定代码（如 1/0 或 true/false 字符串）表示。
  * **空值处理**: CSV中两个逗号之间无内容即为空值。

-----

## 2\. 输入接口 (Inbound) - 外部发送给TA

### 2.1 管理人净值文件 (MGR\_NAV)

  * **来源**: 基金管理人
  * **文件名**: `NAV_{FundCode}_{Date}.csv`
  * **作用**: 提供当日基金净值，用于交易金额/份额的转换计算。

| 字段名 | 字段说明 | 类型/长度 | 是否必填 | 内容示例/约束/枚举值 |
| :--- | :--- | :--- | :--- | :--- |
| `fund_code` | 基金代码 | String(10) | **是** | 示例: `FUND01`<br>约束: 必须与文件名中的 FundCode 一致。 |
| `nav` | 单位净值 | Decimal(10,4)| **是** | 示例: `1.0520`<br>约束: 必须 \> 0。 |
| `date` | 行情日期 | String(8) | **是** | 示例: `20231027`<br>约束: 格式必须为 yyyyMMdd。 |

### 2.2 管理人确认回执文件 (MGR\_CONFIRM)

  * **来源**: 基金管理人
  * **文件名**: `CONFIRM_{Date}.csv`
  * **作用**: 反馈Batch 1提交的交易申请的最终确认结果。

| 字段名 | 字段说明 | 类型/长度 | 是否必填 | 内容示例/约束/枚举值 |
| :--- | :--- | :--- | :--- | :--- |
| `trans_id` | 交易流水号 | String(32) | **是** | 示例: `TX_123456`<br>约束: 必须是当日已申报过的流水号。 |
| `status` | 确认状态 | String(1) | **是** | 枚举值:<br>`1`: 确认成功<br>`0`: 确认失败/拒绝 |
| `confirmed_amount`| 确认金额 | Decimal(18,2)| 否 | 示例: `1000.00`<br>约束: 申购成功时必填。 |
| `confirmed_shares`| 确认份额 | Decimal(18,2)| 否 | 示例: `950.23`<br>约束: 申购/赎回成功时必填。 |
| `confirmed_nav` | 确认净值 | Decimal(10,4)| 否 | 示例: `1.0520`<br>约束: 成功时必填。 |

### 2.3 销售商账户申请文件 (DIST\_ACC)

  * **来源**: 销售机构
  * **文件名**: `{DistID}_ACC_{Date}.csv`
  * **作用**: 提交投资人的开户、销户请求。

| 字段名 | 字段说明 | 类型/长度 | 是否必填 | 内容示例/约束/枚举值 |
| :--- | :--- | :--- | :--- | :--- |
| `request_no` | 申请单号 | String(32) | **是** | 示例: `REQ_2023001`<br>约束: 销售商侧唯一。 |
| `biz_code` | 业务代码 | String(3) | **是** | 枚举值:<br>`001`: 开户 (Open Account)<br>`002`: 销户 (Close Account) |
| `investor_name` | 投资人姓名 | String(64) | **是** | 示例: `张三`<br>约束: 仅业务代码为001时强校验。 |
| `id_no` | 证件号码 | String(32) | **是** | 示例: `110101199001011234`<br>约束: 系统唯一索引键。 |

### 2.4 销售商交易申请文件 (DIST\_TRADE)

  * **来源**: 销售机构
  * **文件名**: `{DistID}_TRADE_{FundCode}_{Date}.csv`
  * **作用**: 提交看穿式交易申请（申购/赎回）。

| 字段名 | 字段说明 | 类型/长度 | 是否必填 | 内容示例/约束/枚举值 |
| :--- | :--- | :--- | :--- | :--- |
| `trans_id` | 交易流水号 | String(32) | **是** | 示例: `TX_ABC001`<br>约束: 全局唯一。 |
| `fund_code` | 基金代码 | String(10) | **是** | 示例: `FUND01`<br>约束: 必须存在于系统产品表中。 |
| `type` | 交易类型 | String(10) | **是** | 枚举值:<br>`PURCHASE`: 申购<br>`REDEEM`: 赎回 |
| `amount_or_shares`| 申请数值 | Decimal(18,2)| **是** | 示例: `1000.00`<br>说明: 若type=PURCHASE，此值为金额；若type=REDEEM，此值为份额。 |
| `account_id` | TA账号 | String(32) | **是** | 示例: `TA12345678`<br>约束: 必须是系统中存在的有效账号（或当日新开户账号）。 |

-----

## 3\. 输出接口 (Outbound) - TA发送给外部

### 3.1 发送给管理人-交易申请汇总 (TO\_MGR\_APPLY)

  * **去向**: 基金管理人
  * **文件名**: `TO_MGR_APPLY_{FundCode}_{Date}.csv`
  * **作用**: 汇总当日通过TA本地校验（验资/验券/验户）的交易请求。

| 字段名 | 字段说明 | 类型/长度 | 是否必填 | 内容示例/约束/枚举值 |
| :--- | :--- | :--- | :--- | :--- |
| `trans_id` | 交易流水号 | String(32) | **是** | 原样透传销售商流水号。 |
| `fund_code` | 基金代码 | String(10) | **是** | 示例: `FUND01` |
| `type` | 交易类型 | String(10) | **是** | `PURCHASE` / `REDEEM` |
| `amount` | 申请金额 | Decimal(18,2)| 否 | 示例: `1000.00`<br>说明: 申购时有值，赎回时为0或空。 |
| `shares` | 申请份额 | Decimal(18,2)| 否 | 示例: `500.00`<br>说明: 赎回时有值，申购时为0或空。 |
| `apply_time` | 申报时间 | DateTime | **是** | 示例: `2023-10-27T10:00:00` |

### 3.2 发送给销售商-账户业务确认 (TO\_DIST\_ACC\_CONFIRM)

  * **去向**: 销售机构
  * **文件名**: `TO_DIST_ACC_CONFIRM_{Date}.csv`
  * **作用**: 反馈开户/销户的处理结果。

| 字段名 | 字段说明 | 类型/长度 | 是否必填 | 内容示例/约束/枚举值 |
| :--- | :--- | :--- | :--- | :--- |
| `request_no` | 原申请单号 | String(32) | **是** | 对应输入的 request\_no。 |
| `biz_code` | 业务代码 | String(3) | **是** | `001` / `002` |
| `ta_account_id` | TA账号 | String(32) | 否 | 示例: `TA_998877`<br>说明: 开户成功时必填，返回生成的账号；失败时为空。 |
| `status` | 处理状态 | String(1) | **是** | 枚举值:<br>`1`: 成功<br>`0`: 失败 |
| `message` | 结果说明 | String(128)| 否 | 示例: `ID_EXISTS` (证件号已存在) |
| `confirm_time` | 确认时间 | DateTime | **是** | TA处理时间。 |

### 3.3 发送给销售商-交易业务确认 (TO\_DIST\_CONFIRM)

  * **去向**: 销售机构
  * **文件名**: `TO_DIST_CONFIRM_{Date}.csv`
  * **作用**: 反馈交易的最终状态（包含TA本地拒单和管理人确认结果）。

| 字段名 | 字段说明 | 类型/长度 | 是否必填 | 内容示例/约束/枚举值 |
| :--- | :--- | :--- | :--- | :--- |
| `trans_id` | 交易流水号 | String(32) | **是** | 对应输入的 trans\_id。 |
| `fund_code` | 基金代码 | String(10) | **是** | 示例: `FUND01` |
| `account_id` | TA账号 | String(32) | **是** | 示例: `TA_12345` |
| `type` | 交易类型 | String(10) | **是** | `PURCHASE` / `REDEEM` |
| `status` | 最终状态 | String(16) | **是** | 枚举值:<br>`CONFIRMED`: 确认成功<br>`REJECTED`: 管理人拒绝<br>`TA_REJECTED`: TA本地校验失败(如份额不足)<br>`REPORTED_TO_MGR`: 已报送(中间状态,一般不出现在最终文件) |
| `confirmed_shares`| 确认份额 | Decimal(18,2)| 否 | 成功时返回最终增加/减少的份额。 |
| `confirmed_nav` | 确认净值 | Decimal(10,4)| 否 | 成功时返回使用的净值。 |
| `message` | 备注/原因 | String(128)| 否 | 示例: `INSUFFICIENT_SHARES` (可用份额不足) |

-----

## 4\. 存量数据文件 (Setup Data) - 仅用于初始化测试环境

### 4.1 账户库 (accounts.json)

用于 Agent 初始化系统内的老用户数据。

| 字段名 | 类型 | 说明 | 示例值 |
| :--- | :--- | :--- | :--- |
| `distributorId` | String | 归属销售商 | `DIST_A` |
| `accountId` | String | TA账号 (主键) | `TA10001` |
| `idNo` | String | 证件号 | `110101198001010000` |
| `name` | String | 姓名 | `OldUser` |
| `status` | String | 状态 | `NORMAL` / `FROZEN` / `CLOSED` |

### 4.2 登记库 (holdings.json)

用于 Agent 初始化老用户的持仓份额。

| 字段名 | 类型 | 说明 | 示例值 |
| :--- | :--- | :--- | :--- |
| `accountId` | String | TA账号 | `TA10001` |
| `fundCode` | String | 基金代码 | `FUND01` |
| `totalShares` | Number | 总份额 | `1000.00` |
| `availableShares`| Number | 可用份额 | `1000.00` (赎回校验时使用此字段) |